<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoBit - Live Real-Time Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0e17;
            --card: #161b22;
            --glow: #00ff88;
            --danger: #ff3366;
        }
        body {
            background: linear-gradient(135deg, #0a0e17 0%, #111927 100%);
            color: white;
            font-family: 'Roboto Mono', monospace;
            min-height: 100vh;
            overflow-x: hidden;
        }
        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 700 4rem;
            text-align: center;
            background: linear-gradient(90deg, #00ff88, #00ffff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
            margin: 2rem 0;
        }
        .card {
            background: var(--card);
            border-radius: 20px;
            border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: all 0.4s;
        }
        .card:hover { transform: translateY(-10px); }
        .chart-container {
            position: relative;
            height: 420px;
            border-radius: 16px;
            overflow: hidden;
            background: #0f1620;
        }
        .price-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 1.4rem;
            font-weight: bold;
            z-index: 10;
            backdrop-filter: blur(10px);
        }
        .signal-marker {
            font-size: 3rem;
            animation: pulse 2s infinite;
            text-shadow: 0 0 20px currentColor;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        .nav-link.active {
            background: linear-gradient(45deg, #00ff88, #00ffff) !important;
            color: black !important;
            font-weight: bold;
        }
        #live-signals {
            background: rgba(0, 255, 136, 0.1);
            border-left: 4px solid #00ff88;
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid px-4">
        <h1>CryptoBit</h1>

        <!-- Live Signals Alert -->
        <div id="live-signals" class="text-center d-none">
            <h3>STRONG SIGNAL DETECTED!</h3>
            <p id="signal-text"></p>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs justify-content-center mb-5" id="coinTabs">
            {% for coin in coins %}
            <li class="nav-item">
                <button class="nav-link {% if loop.first %}active{% endif %}"
                        data-bs-toggle="tab" data-bs-target="#{{ coin }}">
                    {{ coin }}
                </button>
            </li>
            {% endfor %}
        </ul>

        <!-- Charts -->
        <div class="tab-content">
            {% for coin in coins %}
            <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="{{ coin }}">
                <div class="card mb-4">
                    <div class="card-body position-relative">
                        <div class="price-badge" id="{{ coin }}-price">$0.00</div>
                        <h4 class="text-center mb-4">Live Price Chart</h4>
                        <div class="chart-container">
                            <canvas id="{{ coin }}-chart"></canvas>
                        </div>
                        <div class="text-center mt-3">
                            <a href="https://www.tradingview.com/chart/?symbol={{ coin }}USD"
                               target="_blank" class="btn btn-outline-success btn-lg">
                                Open TradingView
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Dashboard -->
        <div class="card mt-4">
            <div class="card-body">
                <h4 class="text-center mb-4">Real-Time Signals</h4>
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Coin</th>
                                <th>Price</th>
                                <th>24h Δ</th>
                                <th>Signal</th>
                                <th>Confidence</th>
                                <th>Reasons</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard"></tbody>
                    </table>
                </div>
                <p class="text-center mt-3" id="fg"></p>
            </div>
        </div>

        <p class="text-center mt-4 text-success" id="status">Connecting...</p>
    </div>

    <script>
        const charts = {};
        let lastSignals = [];

        function updateAll() {
            fetch('/api/data')
                .then(r => r.json())
                .then(data => {
                    // Update dashboard
                    const tbody = document.getElementById('dashboard');
                    tbody.innerHTML = '';
                    data.dashboard.forEach(item => {
                        const row = document.createElement('tr');
                        const changeClass = item.change >= 0 ? 'text-success' : 'text-danger';
                        row.innerHTML = `
                            <td><strong>${item.coin}</strong></td>
                            <td>$${item.price.toLocaleString(undefined, {maximumFractionDigits: 6})}</td>
                            <td class="${changeClass}">${item.change >= 0 ? '+' : ''}${item.change.toFixed(2)}%</td>
                            <td class="${item.color_class}"><strong>${item.signal}</strong></td>
                            <td>${item.prob}%</td>
                            <td><small>${item.reasons}</small></td>
                        `;
                        tbody.appendChild(row);
                    });

                    // Update F&G
                    document.getElementById('fg').innerHTML =
                        `Fear & Greed: <strong style="color:${data.fg<25?'#ff0066':data.fg>75?'#00ff88':'#ffaa00'}">${data.fg}</strong>/100`;

                    // Update price badges
                    Object.keys(data.chart_data).forEach(coin => {
                        document.getElementById(`${coin}-price`).textContent =
                            `$${data.chart_data[coin].current_price.toLocaleString()}`;
                    });

                    // Live signal alerts
                    data.signals.forEach(sig => {
                        if (!lastSignals.includes(sig.time)) {
                            document.getElementById('live-signals').classList.remove('d-none');
                            document.getElementById('signal-text').innerHTML =
                                `<span class="signal-marker">${sig.signal.includes('BUY') ? 'Up Arrow' : 'Down Arrow'}</span>
                                 <strong>${sig.coin} ${sig.signal}</strong> at $${sig.price.toLocaleString()}
                                 (${sig.prob}% confidence)`;
                            setTimeout(() => {
                                document.getElementById('live-signals').classList.add('d-none');
                            }, 8000);
                        }
                    });
                    lastSignals = data.signals.map(s => s.time);

                    // Update charts with live data
                    Object.keys(data.chart_data).forEach(coin => {
                        const chartData = data.chart_data[coin];
                        const ctx = document.getElementById(`${coin}-chart`).getContext('2d');

                        if (!charts[coin]) {
                            charts[coin] = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: chartData.prices.map((_, i) => i),
                                    datasets: [{
                                        label: 'Price',
                                        data: chartData.prices,
                                        borderColor: '#00ff88',
                                        backgroundColor: 'rgba(0,255,136,0.1)',
                                        borderWidth: 3,
                                        pointRadius: 0,
                                        tension: 0.3,
                                        fill: true
                                    }, {
                                        label: 'EMA 12',
                                        data: chartData.ema_fast,
                                        borderColor: '#ffaa00',
                                        borderWidth: 2
                                    }, {
                                        label: 'EMA 26',
                                        data: chartData.ema_slow,
                                        borderColor: '#ff00ff',
                                        borderWidth: 2
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { labels: { color: 'white' } },
                                        tooltip: {
                                            mode: 'index',
                                            intersect: false,
                                            backgroundColor: 'rgba(0,0,0,0.8)',
                                            titleColor: '#00ffff',
                                            bodyColor: 'white',
                                            borderColor: '#00ff88',
                                            borderWidth: 2
                                        }
                                    },
                                    scales: {
                                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666' } },
                                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666' } }
                                    }
                                }
                            });
                        } else {
                            const chart = charts[coin];
                            chart.data.labels = chartData.prices.map((_, i) => i);
                            chart.data.datasets[0].data = chartData.prices;
                            chart.data.datasets[1].data = chartData.ema_fast;
                            chart.data.datasets[2].data = chartData.ema_slow;
                            chart.update('none'); // Fast update
                        }
                    });

                    document.getElementById('status').textContent =
                        `LIVE • Updated ${new Date().toLocaleTimeString()}`;
                });
        }

        // Update every 15 seconds
        setInterval(updateAll, 15000);
        updateAll();
    </script>
</body>
</html>