<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoBit - Coin Price Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js" rel="stylesheet">
    <style>
        body { background-color: #0d1117; color: white; }
        .table { color: white; }
        .text-purple { color: #FF00FF; }
        .card { background-color: #1f2937; border: none; }
        .nav-tabs .nav-link { color: white; background-color: #0d1117; }
        .nav-tabs .nav-link.active { background-color: #1f2937; color: cyan; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">CryptoBit - Coin Price Tracker</h1>

        <ul class="nav nav-tabs" id="coinTabs" role="tablist">
            {% for coin in coins %}
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if loop.first %}active{% endif %}" id="{{ coin }}-tab" data-bs-toggle="tab" data-bs-target="#{{ coin }}" type="button" role="tab">{{ coin }}</button>
            </li>
            {% endfor %}
        </ul>

        <div class="tab-content mt-3">
            {% for coin in coins %}
            <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="{{ coin }}" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Price Chart</h5>
                        <img id="{{ coin }}-chart" src="" alt="{{ coin }} Chart" class="img-fluid">
                    </div>
                </div>
                <a href="https://www.tradingview.com/chart/?symbol={{ coin }}USD" target="_blank" class="btn btn-primary mt-2">Open TradingView</a>
            </div>
            {% endfor %}
        </div>

        <div class="card mt-5">
            <div class="card-body">
                <h5 class="card-title">Dashboard</h5>
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>Coin</th>
                            <th>Price (24h Î”)</th>
                            <th>Signal (Conf)</th>
                            <th>Top Reasons</th>
                        </tr>
                    </thead>
                    <tbody id="dashboard-body">
                    </tbody>
                </table>
                <p id="fg-index"></p>
            </div>
        </div>

        <p id="status" class="text-center mt-3 text-muted"></p>
    </div>

    <script>
        function updateDashboard() {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    const dashboardBody = document.getElementById('dashboard-body');
                    dashboardBody.innerHTML = '';
                    data.dashboard.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.coin}</td>
                            <td>$${item.price.toLocaleString(undefined, {minimumFractionDigits: 2})} (${item.change.toFixed(2)}%)</td>
                            <td class="${item.color_class}">${item.signal} (${item.prob}%)</td>
                            <td>${item.reasons}</td>
                        `;
                        dashboardBody.appendChild(row);
                    });
                    document.getElementById('fg-index').innerText = `F&G: ${data.fg}/100 (${data.fg < 25 ? 'Extreme Fear' : data.fg > 80 ? 'Extreme Greed' : 'Neutral'})`;
                    document.getElementById('status').innerText = `Last update: ${new Date(data.timestamp).toLocaleTimeString()} | Status: Running`;

                    // Update charts
                    for (const coin in data.charts) {
                        document.getElementById(`${coin}-chart`).src = `data:image/png;base64,${data.charts[coin]}`;
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        setInterval(updateDashboard, 15000);
        updateDashboard();  // Initial call
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>