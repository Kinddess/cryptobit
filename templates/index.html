<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoBit - Live Crypto Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0d1117;
            --card: #1f2937;
            --primary: #00ff88;
            --accent: #00ffff;
            --danger: #ff0066;
            --purple: #ff00ff;
            --warning: #ffaa00;
        }
        body {
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            color: #0d1117;
            color: white;
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
        }
        h1 {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            font-size: 3rem;
            margin-bottom: 2rem;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }
        .card {
            background-color: var(--card);
            border: none;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 40px rgba(0, 255, 136, 0.2);
        }
        .nav-tabs .nav-link {
            color: #aaa;
            background-color: #161b22;
            border: none;
            border-radius: 12px 12px 0 0;
            margin: 0 5px;
            padding: 12px 24px;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(90deg, var(--primary), var(--accent));
            color: white;
            font-weight: 700;
        }
        .table {
            color: white;
            background-color: #161b22;
            border-radius: 12px;
            overflow: hidden;
        }
        .table th {
            background-color: #21262d;
            color: var(--accent);
            font-weight: 600;
        }
        .text-success { color: #00ff88 !important; }
        .text-info { color: #00ffff !important; }
        .text-danger { color: #ff0066 !important; }
        .text-purple { color: #ff00ff !important; }
        .text-warning { color: #ffaa00 !important; }
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        .btn-tradingview {
            background: linear-gradient(45deg, var(--primary), var(--accent));
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .btn-tradingview:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }
        #status {
            font-family: 'Orbitron', monospace;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
        @media (max-width: 768px) {
            h1 { font-size: 2.2rem; }
            .nav-tabs .nav-link { padding: 10px 16px; font-size: 0.9rem; }
            .chart-container { height: 300px; }
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4 mt-md-5 px-4">
        <h1>CryptoBit</h1>

        <!-- Coin Tabs -->
        <ul class="nav nav-tabs justify-content-center mb-4" id="coinTabs" role="tablist">
            {% for coin in coins %}
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if loop.first %}active{% endif %}"
                        id="{{ coin }}-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#{{ coin }}"
                        type="button" role="tab">
                    {{ coin }}
                </button>
            </li>
            {% endfor %}
        </ul>

        <!-- Chart Tabs Content -->
        <div class="tab-content">
            {% for coin in coins %}
            <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="{{ coin }}" role="tabpanel">
                <div class="row justify-content-center">
                    <div class="col-lg-10 col-12">
                        <div class="card">
                            <div class="card-body p-4">
                                <h5 class="text-center mb-4">Live Price Chart</h5>
                                <div class="chart-container">
                                    <canvas id="{{ coin }}-chart-canvas"></canvas>
                                </div>
                                <div class="text-center mt-4">
                                    <a href="https://www.tradingview.com/chart/?symbol={{ coin }}USD"
                                       target="_blank"
                                       class="btn btn-tradingview">
                                        Open Full Chart on TradingView
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Dashboard -->
        <div class="row mt-5 justify-content-center">
            <div class="col-lg-10 col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title text-center mb-4">Real-Time Signal Dashboard</h5>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Coin</th>
                                        <th>Price (24h Δ)</th>
                                        <th>Signal (Confidence)</th>
                                        <th>Key Reasons</th>
                                    </tr>
                                </thead>
                                <tbody id="dashboard-body" class="fs="fs-5">
                                </tbody>
                            </table>
                        </div>
                        <p id="fg-index" class="text-center mt-4 fs-4"></p>
                    </div>
                </div>
            </div>
        </div>

        <p id="status" class="text-center mt-4 fs-6"></p>
    </div>

    <script>
        const charts = {};

        function updateDashboard() {
            fetch('/api/data')
                .then(r => r.json())
                .then(data => {
                    // Update Dashboard Table
                    const tbody = document.getElementById('dashboard-body');
                    tbody.innerHTML = '';
                    data.dashboard.forEach(item => {
                        const row = document.createElement('tr');
                        const changeColor = item.change >= 0 ? 'text-success' : 'text-danger';
                        row.innerHTML = `
                            <td><strong>${item.coin}</strong></td>
                            <td><strong>$${item.price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 6})}</strong>
                                <span class="${changeColor}">(${item.change >= 0 ? '+' : ''}${item.change.toFixed(2)}%)</span></td>
                            <td class="${item.color_class}"><strong>${item.signal}</strong> <em>(${item.prob}%)</em></td>
                            <td>${item.reasons || '-'}</td>
                        `;
                        tbody.appendChild(row);
                    });

                    // Update Fear & Greed
                    const fgText = data.fg < 25 ? "Extreme Fear" :
                                  data.fg < 45 ? "Fear" :
                                  data.fg < 55 ? "Neutral" :
                                  data.fg < 75 ? "Greed" : "Extreme Greed";
                    const fgColor = data.fg < 25 ? "#ff0066" : data.fg > 75 ? "#00ff88" : "#ffaa00";
                    document.getElementById('fg-index').innerHTML =
                        `Fear & Greed Index: <strong style="color:${fgColor}">${data.fg}/100</strong> → ${fgText}`;

                    // Update Status
                    document.getElementById('status').textContent =
                        `Live • Last update: ${new Date(data.timestamp).toLocaleTimeString()}`;

                    // Update Charts with Interactive Tooltips
                    for (const coin in data.chart_data) {
                        const ctx = document.getElementById(`${coin}-chart-canvas`).getContext('2d');
                        const chartData = data.chart_data[coin];

                        if (!charts[coin]) {
                            charts[coin] = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: chartData.labels,
                                    datasets: [
                                        {
                                            label: 'Price (USD)',
                                            data: chartData.prices,
                                            borderColor: '#00ff88',
                                            backgroundColor: 'rgba(0, 255, 136, 0.1)',
                                            borderWidth: 3,
                                            pointRadius: 0,
                                            tension: 0.2,
                                            fill: false
                                        },
                                        {
                                            label: 'EMA 12',
                                            data: chartData.ema_fast,
                                            borderColor: '#ffaa00',
                                            borderWidth: 2,
                                            pointRadius: 0,
                                            tension: 0.2
                                        },
                                        {
                                            label: 'EMA 26',
                                            data: chartData.ema_slow,
                                            borderColor: '#ff00ff',
                                            borderWidth: 2,
                                            pointRadius: 0,
                                            tension: 0.2
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    interaction: {
                                        mode: 'index',
                                        intersect: false,
                                    },
                                    plugins: {
                                        legend: {
                                            labels: { color: 'white', font: { size: 14 } }
                                        },
                                        tooltip: {
                                            backgroundColor: 'rgba(0,0,0,0.8)',
                                            titleColor: '#00ffff',
                                            bodyColor: 'white',
                                            borderColor: '#00ff88',
                                            borderWidth: 1,
                                            cornerRadius: 10,
                                            displayColors: true,
                                            callbacks: {
                                                label: function(context) {
                                                    let label = context.dataset.label || '';
                                                    if (label) label += ': ';
                                                    if (context.parsed.y !== null) {
                                                        label += '$' + context.parsed.y.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 6});
                                                    }
                                                    return label;
                                                }
                                            }
                                        }
                                    },
                                    scales: {
                                        x: {
                                            display: true,
                                            grid: { color: 'rgba(255,255,255,0.05)' },
                                            ticks: { color: '#888' }
                                        },
                                        y: {
                                            display: true,
                                            grid: { color: 'rgba(255,255,255,0.05)' },
                                            ticks: { color: '#888' }
                                        }
                                    },
                                    animation: {
                                        duration: 1200,
                                        easing: 'easeOutQuart'
                                    }
                                }
                            });
                        } else {
                            // Update existing chart
                            const chart = charts[coin];
                            chart.data.labels = chartData.labels;
                            chart.data.datasets[0].data = chartData.prices;
                            chart.data.datasets[1].data = chartData.ema_fast;
                            chart.data.datasets[2].data = chartData.ema_slow;
                            chart.update('quiet');
                        }
                    }
                })
                .catch(err => console.error('Update failed:', err));
        }

        // Update every 15 seconds
        setInterval(updateDashboard, 15000);
        updateDashboard(); // First load
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>