<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoBit - Live Crypto Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Roboto+Mono:wght@300;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0e17;
            --card: #111827;
            --primary: #00ff9d;
            --danger: #ff3366;
            --purple: #9d00ff;
            --warning: #ffaa00;
            --info: #00ffff;
        }
        body {
            background: linear-gradient(135deg, #0a0e17 0%, #0f172a 100%);
            color: white;
            font-family: 'Roboto Mono', monospace;
            min-height: 100vh;
            margin: 0;
        }
        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            text-align: center;
            background: linear-gradient(90deg, #00ff9d, #00ffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 2rem 0;
            text-shadow: 0 0 30px rgba(0, 255, 157, 0.5);
        }
        .live-badge {
            position: absolute;
            top: 15px;
            right: 20px;
            background: #ff0066;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            animation: pulse 2s infinite;
            z-index: 10;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 102, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 102, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 102, 0); }
        }
        .signal-badge {
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1rem;
            animation: glow 2s infinite alternate;
        }
        @keyframes glow {
            from { box-shadow: 0 0 10px currentColor; }
            to { box-shadow: 0 0 20px currentColor; }
        }
        .card {
            background: var(--card);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            overflow: hidden;
            transition: 0.4s;
        }
        .card:hover { transform: translateY(-10px); }
        .chart-container {
            position: relative;
            height: 420px;
            padding: 20px;
        }
        canvas { border-radius: 16px; }
        .price-display {
            font-size: 2.2rem;
            font-weight: 800;
            font-family: 'Orbitron';
            background: linear-gradient(45deg, #00ff9d, #00ffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .nav-tabs .nav-link {
            color: #888;
            background: #161b22;
            border-radius: 15px 15px 0 0;
            margin: 0 8px;
            padding: 14px 28px;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(90deg, var(--primary), #00ffff);
            color: white;
            font-weight: 700;
        }
        .table {
            background: #161b22;
            border-radius: 16px;
            overflow: hidden;
        }
        .table th {
            background: #1e293b;
            color: #00ffff;
        }
        .alert-new {
            animation: flash 1s ease-in-out 3;
        }
        @keyframes flash {
            0%, 100% { background-color: inherit; }
            50% { background-color: rgba(255, 255, 0, 0.3); }
        }
        @media (max-width: 768px) {
            h1 { font-size: 2.5rem; }
            .chart-container { height: 320px; }
        }
    </style>
</head>
<body>
    <div class="container-fluid px-4">
        <h1>CryptoBit</h1>

        <!-- Tabs -->
        <ul class="nav nav-tabs justify-content-center mb-4" id="coinTabs">
            {% for coin in coins %}
            <li class="nav-item">
                <button class="nav-link {% if loop.first %}active{% endif %}"
                        id="{{ coin }}-tab" data-bs-toggle="tab"
                        data-bs-target="#{{ coin }}" type="button">
                    {{ coin }}
                </button>
            </li>
            {% endfor %}
        </ul>

        <!-- Live Charts -->
        <div class="tab-content">
            {% for coin in coins %}
            <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="{{ coin }}">
                <div class="card position-relative mb-4">
                    <div class="live-badge">LIVE</div>
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="mb-0">{{ coin }}/USD</h3>
                            <div>
                                <span class="price-display" id="{{ coin }}-price">$0.00</span>
                                <span id="{{ coin }}-change" class="ms-3"></span>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="{{ coin }}-chart"></canvas>
                        </div>
                        <div class="text-center mt-3">
                            <span id="{{ coin }}-signal" class="signal-badge">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="text-center mb-5">
                    <a href="https://www.tradingview.com/chart/?symbol={{ coin }}USD"
                       target="_blank" class="btn btn-lg"
                       style="background: linear-gradient(45deg, #00ff9d, #00ffff); color: black; font-weight: bold;">
                        Open Full TradingView Chart
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>

        </div>

        <!-- Dashboard Table -->
        <div class="card mt-5">
            <div class="card-body">
                <h4 class="text-center mb-4">Live Signal Dashboard</h4>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Coin</th>
                                <th>Price</th>
                                <th>24h Δ</th>
                                <th>Signal</th>
                                <th>Confidence</th>
                                <th>Reasons</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard">
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-4">
                    <h5>Fear & Greed Index: <span id="fg">—</span></h5>
                </div>
            </div>
        </div>

        <p class="text-center mt-4 text-muted" id="last-update"></p>
    </div>

    <script>
        const charts = {};
        let lastSignals = {};

        function updateAll() {
            fetch('/api/data')
                .then(r => r.json())
                .then(data => {
                    // Update Dashboard
                    const tbody = document.getElementById('dashboard');
                    tbody.innerHTML = '';
                    data.dashboard.forEach(item => {
                        const row = document.createElement('tr');
                        const isNewSignal = lastSignals[item.coin] !== item.signal;
                        if (isNewSignal) row.classList.add('alert-new');

                        const changeColor = item.change >= 0 ? '#00ff88' : '#ff3366';
                        row.innerHTML = `
                            <td><strong>${item.coin}</strong></td>
                            <td>$${item.price.toLocaleString(undefined, {maximumFractionDigits: 6})}</td>
                            <td style="color: ${changeColor}">${item.change >= 0 ? '+' : ''}${item.change.toFixed(2)}%</td>
                            <td><strong class="${item.color_class}">${item.signal}</strong></td>
                            <td><strong>${item.prob}%</strong></td>
                            <td>${item.reasons || '-'}</td>
                        `;
                        tbody.appendChild(row);
                        lastSignals[item.coin] = item.signal;

                        // Update price & signal in chart tab
                        document.getElementById(`${item.coin}-price`).textContent =
                            '$' + item.price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 6});
                        document.getElementById(`${item.coin}-change`).innerHTML =
                            `<span style="color:${changeColor}">(${item.change >= 0 ? '+' : ''}${item.change.toFixed(2)}%)</span>`;

                        const signalEl = document.getElementById(`${item.coin}-signal`);
                        signalEl.textContent = item.signal + ' • ' + item.prob + '%';
                        signalEl.style.background = item.signal.includes('BUY') || 'Bullish') ? 'rgba(0,255,157,0.2)' :
                                                   item.signal.includes('SELL') ? 'rgba(255,51,102,0.2)' : 'rgba(255,170,0,0.2)';
                        signalEl.style.color = item.signal.includes('BUY') ? '#00ff9d' :
                                              item.signal.includes('SELL') ? '#ff3366' : '#ffaa00';
                    });

                    // Update F&G
                    const fgText = data.fg < 25 ? "EXTREME FEAR" :
                                  data.fg < 45 ? "FEAR" :
                                  data.fg < 55 ? "NEUTRAL" :
                                  data.fg < 75 ? "GREED" : "EXTREME GREED";
                    document.getElementById('fg').innerHTML =
                        `<strong style="color:${data.fg < 25 ? '#ff3366' : data.fg > 75 ? '#00ff88' : '#ffaa00'}">${data.fg}/100</strong> → ${fgText}`;

                    // Update last update
                    document.getElementById('last-update').textContent =
                        `Live • Updated: ${new Date(data.timestamp).toLocaleTimeString()}`;

                    // Update all charts
                    Object.keys(data.chart_data).forEach(coin => {
                        const chartData = data.chart_data[coin];
                        const ctx = document.getElementById(`${coin}-chart`).getContext('2d');

                        if (!charts[coin]) {
                            charts[coin] = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: chartData.labels,
                                    datasets: [{
                                        label: 'Price',
                                        data: chartData.prices,
                                        borderColor: '#00ff9d',
                                        backgroundColor: 'rgba(0, 255, 157, 0.1)',
                                        borderWidth: 3,
                                        pointRadius: 0,
                                        tension: 0.3,
                                        fill: true
                                    }, {
                                        label: 'EMA 12',
                                        data: chartData.ema_fast,
                                        borderColor: '#ffaa00',
                                        borderWidth: 2,
                                        pointRadius: 0
                                    }, {
                                        label: 'EMA 26',
                                        data: chartData.ema_slow,
                                        borderColor: '#9d00ff',
                                        borderWidth: 2,
                                        pointRadius: 0
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            mode: 'index',
                                            intersect: false,
                                            backgroundColor: 'rgba(0,0,0,0.8)',
                                            titleColor: '#00ffff',
                                            bodyColor: 'white',
                                            borderColor: '#00ff88',
                                            borderWidth: 2,
                                            cornerRadius: 12,
                                            displayColors: false,
                                            callbacks: {
                                                label: ctx => {
                                                    const val = ctx.parsed.y;
                                                    return ctx.dataset.label + ': $' + val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 6});
                                                }
                                            }
                                        }
                                    },
                                    scales: {
                                        x: { display: false },
                                        y: {
                                            grid: { color: 'rgba(255,255,255,0.05)' },
                                            ticks: { color: '#888' }
                                        }
                                    },
                                    animation: { duration: 0 },
                                    hover: { mode: 'nearest', intersect: true }
                                }
                            });
                        } else {
                            const chart = charts[coin];
                            chart.data.labels = chartData.labels;
                            chart.data.datasets[0].data = chartData.prices;
                            chart.data.datasets[1].data = chartData.ema_fast;
                            chart.data.datasets[2].data = chartData.ema_slow;
                            chart.update('none'); // Instant update for live feel
                        }
                    });
                });
        }

        // Update every 3 seconds for real live feel
        setInterval(updateAll, 3000);
        updateAll();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>